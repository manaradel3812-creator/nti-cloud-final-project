name: CD Pipeline

on:
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: 'Deployment Mode'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - manual

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:

      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/download-artifact@v3
        with:
          submodules: true

      # 2Ô∏è‚É£ Download CI outputs artifact (if CI workflow uploaded it)
      - name: Download Terraform & ECR info from CI
        uses: actions/download-artifact@v3
        with:
          name: terraform-outputs
          path: .

      # 3Ô∏è‚É£ Parse outputs
      - name: Parse CI outputs
        id: parse_outputs
        run: |
          CLUSTER_NAME=$(jq -r '.eks_cluster_name.value' tf-outputs.json)
          AWS_REGION=$(jq -r '.aws_region.value // "us-east-1"' tf-outputs.json)
          ECR_REPOSITORY=$(jq -r '.manar_app_ecr_url.value' tf-outputs.json)
          IMAGE_TAG=$(jq -r '.image_tag.value // "'"${GITHUB_RUN_NUMBER}"'"')

          echo "CLUSTER_NAME=$CLUSTER_NAME" >> $GITHUB_ENV
          echo "AWS_REGION=$AWS_REGION" >> $GITHUB_ENV
          echo "ECR_REPOSITORY=$ECR_REPOSITORY" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      # 4Ô∏è‚É£ Configure AWS Credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 5Ô∏è‚É£ Login to AWS ECR
      - name: Login to AWS ECR
        uses: aws-actions/amazon-ecr-login@v2
        env:
          AWS_REGION: ${{ env.AWS_REGION }}

      # 6Ô∏è‚É£ Scan image with Trivy
      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}"
          format: table
          exit-code: 1
          ignore-unfixed: true
          vuln-type: os,library
          severity: CRITICAL,HIGH

      # 7Ô∏è‚É£ Checkout GitOps repo
      - name: Checkout GitOps repository
        run: |
          git clone https://${{ secrets.GITOPS_TOKEN }}@github.com/manaradel3812-creator/nti-cloud-final-project.git

      # 8Ô∏è‚É£ Update Helm values.yaml with new image tag
      - name: Update Helm values.yaml
        run: |
          cd gitops-repo
          sed -i "s/tag: .*/tag: \"${{ env.IMAGE_TAG }}\"/g" charts/hello-app/values.yaml
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add charts/hello-app/values.yaml
          git commit -m "Update image tag to ${{ env.IMAGE_TAG }} [skip ci]" || echo "No changes to commit"
          git push origin main

      # 9Ô∏è‚É£ Setup kubectl
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      # üîü Setup Helm
      - name: Setup Helm
        uses: azure/setup-helm@v4

      # 1Ô∏è‚É£1Ô∏è‚É£ Update kubeconfig
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.CLUSTER_NAME }}

      # 1Ô∏è‚É£2Ô∏è‚É£ Apply ArgoCD Application YAML
      - name: Apply ArgoCD Application
        run: |
          kubectl apply -f gitops-repo/k8s-configs/argocd-app.yaml
