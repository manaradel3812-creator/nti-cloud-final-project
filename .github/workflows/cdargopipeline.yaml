name: CD Pipeline with ArgoCD

on:
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: 'Deployment Mode'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - manual
      image_tag:
        description: 'Docker Image Tag'
        required: true
        type: string
      cluster_name:
        description: 'EKS Cluster Name'
        required: false
        type: string
        default: 'manar-eks-cluster'
      aws_region:
        description: 'AWS Region'
        required: false
        type: string
        default: 'us-east-1'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Set environment variables
      - name: Set deployment config
        env:
          INPUT_IMAGE_TAG: ${{ github.event.inputs.image_tag }}
          INPUT_CLUSTER: ${{ github.event.inputs.cluster_name }}
          INPUT_REGION: ${{ github.event.inputs.aws_region }}
        run: |
          echo "CLUSTER_NAME=${INPUT_CLUSTER}" >> $GITHUB_ENV
          echo "AWS_REGION=${INPUT_REGION}" >> $GITHUB_ENV
          echo "ECR_REPOSITORY=${{ secrets.ECR_REPOSITORY }}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${INPUT_IMAGE_TAG}" >> $GITHUB_ENV
          
          echo "âœ… Deployment config:"
          echo "  Cluster: ${INPUT_CLUSTER}"
          echo "  Region: ${INPUT_REGION}"
          echo "  Image: ${{ secrets.ECR_REPOSITORY }}:${INPUT_IMAGE_TAG}"

      # 3ï¸âƒ£ Configure AWS Credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 4ï¸âƒ£ Login to AWS ECR
      - name: Login to AWS ECR
        uses: aws-actions/amazon-ecr-login@v2

      # 5ï¸âƒ£ Verify image exists in ECR
      - name: Verify image exists
        env:
          IMAGE_REF: ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
        run: |
          echo "ğŸ” Checking if image exists in ECR..."
          if docker pull "$IMAGE_REF"; then
            echo "âœ… Image found: $IMAGE_REF"
          else
            echo "âŒ Image not found: $IMAGE_REF"
            echo "Available tags:"
            aws ecr describe-images \
              --repository-name manar-app \
              --query 'imageDetails[*].imageTags' \
              --output table || true
            exit 1
          fi

      # 6ï¸âƒ£ Scan image with Trivy
      - name: Trivy vulnerability scan
        continue-on-error: true
        env:
          IMAGE_REF: ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --severity CRITICAL,HIGH \
            --exit-code 0 \
            --no-progress \
            "$IMAGE_REF"

      # 7ï¸âƒ£ Manual Approval
      - name: Manual Approval Gate
        if: ${{ github.event.inputs.deploy_mode == 'manual' }}
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: manaradel3812-creator
          minimum-approvals: 1
          issue-title: "ğŸš€ Deploy ${{ env.IMAGE_TAG }} to Production"
          issue-body: |
            **Deployment Details:**
            - Image: `${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}`
            - Cluster: `${{ env.CLUSTER_NAME }}`
            - Region: `${{ env.AWS_REGION }}`

      # 8ï¸âƒ£ Checkout GitOps repository
      - name: Checkout GitOps repository
        env:
          GITOPS_TOKEN: ${{ secrets.GITOPS_TOKEN }}
        run: |
          git clone "https://${GITOPS_TOKEN}@github.com/manaradel3812-creator/nti-cloud-final-project.git" gitops-repo

      # 9ï¸âƒ£ Update Helm values.yaml
      - name: Update Helm values.yaml
        env:
          NEW_IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          cd gitops-repo
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† values.yaml
          VALUES_FILE=""
          for path in "charts/hello-app/values.yaml" "helmchart/values.yaml" "helm/values.yaml" "charts/values.yaml"; do
            if [ -f "$path" ]; then
              VALUES_FILE="$path"
              break
            fi
          done
          
          if [ -z "$VALUES_FILE" ]; then
            echo "âŒ values.yaml not found! Searching..."
            find . -name "values.yaml" -type f
            exit 1
          fi
          
          echo "ğŸ“ Updating $VALUES_FILE"
          
          # ØªØ­Ø¯ÙŠØ« image tag
          sed -i "s|tag:.*|tag: \"${NEW_IMAGE_TAG}\"|g" "$VALUES_FILE"
          
          # Ø¹Ø±Ø¶ Ø§Ù„ØªØºÙŠÙŠØ±
          echo "âœ… Updated section:"
          grep -B2 -A2 "tag:" "$VALUES_FILE" || grep -A5 "image:" "$VALUES_FILE"
          
          # Commit & Push
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add "$VALUES_FILE"
          
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes detected"
          else
            git commit -m "ğŸš€ Deploy image ${NEW_IMAGE_TAG} [skip ci]"
            git push origin main
            echo "âœ… Changes pushed to GitOps repo"
          fi

      # ğŸ”Ÿ Setup kubectl
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      # 1ï¸âƒ£1ï¸âƒ£ Update kubeconfig
      - name: Update kubeconfig
        env:
          REGION: ${{ env.AWS_REGION }}
          CLUSTER: ${{ env.CLUSTER_NAME }}
        run: |
          aws eks update-kubeconfig --region "$REGION" --name "$CLUSTER"
          kubectl cluster-info

      # 1ï¸âƒ£2ï¸âƒ£ Install/Verify ArgoCD
      - name: Setup ArgoCD
        run: |
          if ! kubectl get namespace argocd &>/dev/null; then
            echo "ğŸ“¦ Installing ArgoCD..."
            kubectl create namespace argocd
            kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
            
            echo "â³ Waiting for ArgoCD pods..."
            kubectl wait --for=condition=Ready pods --all -n argocd --timeout=300s
            
            echo "âœ… ArgoCD installed successfully"
          else
            echo "âœ… ArgoCD already installed"
          fi
          
          # Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© ArgoCD
          kubectl get pods -n argocd

      # 1ï¸âƒ£3ï¸âƒ£ Apply ArgoCD Application
      - name: Deploy ArgoCD Application
        run: |
          cd gitops-repo
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† argocd-app.yaml
          ARGOCD_FILE=""
          for path in "k8s-configs/argocd-app.yaml" "argocd/app.yaml" "argocd-app.yaml"; do
            if [ -f "$path" ]; then
              ARGOCD_FILE="$path"
              break
            fi
          done
          
          if [ -n "$ARGOCD_FILE" ]; then
            echo "ğŸ“‹ Applying ArgoCD Application from $ARGOCD_FILE"
            kubectl apply -f "$ARGOCD_FILE"
            echo "âœ… ArgoCD Application created/updated"
          else
            echo "âš ï¸ ArgoCD Application manifest not found!"
            echo "Available files:"
            find . -name "*.yaml" -o -name "*.yml"
            
            echo ""
            echo "ğŸ’¡ Creating basic ArgoCD Application..."
            
            cat > /tmp/argocd-app.yaml <<EOF
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: manar-app
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/manaradel3812-creator/nti-cloud-final-project.git
    targetRevision: main
    path: helmchart
    helm:
      valueFiles:
        - values.yaml
  destination:
    server: https://kubernetes.default.svc
    namespace: default
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
EOF
            
            kubectl apply -f /tmp/argocd-app.yaml
            echo "âœ… Basic ArgoCD Application created"
          fi

      # 1ï¸âƒ£4ï¸âƒ£ Trigger ArgoCD Sync
      - name: Sync ArgoCD Application
        run: |
          echo "ğŸ”„ Waiting for ArgoCD to detect changes..."
          sleep 20
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù…Ù„ sync ÙŠØ¯ÙˆÙŠ
          kubectl patch application manar-app -n argocd \
            --type merge \
            -p '{"operation":{"initiatedBy":{"username":"github-action"},"sync":{"revision":"main"}}}' \
            2>/dev/null || echo "âš ï¸ Manual sync failed, ArgoCD will auto-sync"

      # 1ï¸âƒ£5ï¸âƒ£ Verify Deployment
      - name: Verify deployment
        env:
          DEPLOYED_IMAGE: ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
        run: |
          echo "â³ Waiting for deployment..."
          sleep 40
          
          echo ""
          echo "ğŸ“Š Cluster Status:"
          echo "=================="
          
          echo ""
          echo "ğŸ¯ ArgoCD Applications:"
          kubectl get applications -n argocd || true
          
          echo ""
          echo "ğŸ“¦ Pods in default namespace:"
          kubectl get pods -n default
          
          echo ""
          echo "ğŸŒ Services:"
          kubectl get svc -n default
          
          echo ""
          echo "ğŸ”€ Ingress:"
          kubectl get ingress -n default || echo "No ingress found"
          
          echo ""
          echo "âœ… Deployment completed!"
          echo "ğŸ¯ Image deployed: ${DEPLOYED_IMAGE}"
