name: CD Pipeline - ArgoCD Deployment

on:
  workflow_run:
    workflows: ["CI Docker + ECR + Helm Deployment"]
    types:
      - completed
  
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: true
        default: 'latest'
      env:
        description: 'Environment'
        required: true
        default: 'nonprod'
        type: choice
        options:
          - nonprod
          - prod

env:
  AWS_REGION: us-east-1
  ARGOCD_NAMESPACE: argocd

jobs:
  update-argocd:
    name: Update ArgoCD Application
    runs-on: ubuntu-latest
    
    # Only run if CI pipeline succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      # 1Ô∏è‚É£ Checkout Repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # 2Ô∏è‚É£ Download CI Pipeline Outputs
      - name: Download CI outputs
        if: github.event_name == 'workflow_run'
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: ci-docker-pipeline.yaml
          name: terraform-outputs
          path: .
          search_artifacts: true
          workflow_conclusion: success

      # 3Ô∏è‚É£ Parse Deployment Info
      - name: Parse deployment info
        id: parse_info
        run: |
          if [ -f "tf-outputs.json" ]; then
            CLUSTER_NAME=$(jq -r '.eks_cluster_name.value' tf-outputs.json)
            ECR_REPO=$(jq -r '.manar_app_ecr_url.value' tf-outputs.json)
            IMAGE_TAG=$(jq -r '.image_tag.value' tf-outputs.json)
          else
            echo "Using manual inputs..."
            CLUSTER_NAME="eks-${{ github.event.inputs.env }}"
            ECR_REPO="${{ secrets.ECR_REPOSITORY_URL }}"
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          fi
          
          echo "CLUSTER_NAME=$CLUSTER_NAME" >> $GITHUB_ENV
          echo "ECR_REPOSITORY=$ECR_REPO" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          
          echo "üì¶ Deployment Info:"
          echo "  Cluster: $CLUSTER_NAME"
          echo "  ECR Repo: $ECR_REPO"
          echo "  Image Tag: $IMAGE_TAG"

      # 4Ô∏è‚É£ Configure AWS Credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 5Ô∏è‚É£ Setup kubectl
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      # 6Ô∏è‚É£ Update kubeconfig
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.CLUSTER_NAME }}

      # 7Ô∏è‚É£ Get ArgoCD Admin Password
      - name: Get ArgoCD credentials
        id: argocd_creds
        run: |
          ARGOCD_PASSWORD=$(kubectl -n ${{ env.ARGOCD_NAMESPACE }} \
            get secret argocd-initial-admin-secret \
            -o jsonpath="{.data.password}" | base64 -d)
          
          echo "::add-mask::$ARGOCD_PASSWORD"
          echo "ARGOCD_PASSWORD=$ARGOCD_PASSWORD" >> $GITHUB_ENV
          
          # Get ArgoCD server URL
          ARGOCD_SERVER=$(kubectl -n ${{ env.ARGOCD_NAMESPACE }} \
            get svc argocd-server \
            -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          
          if [ -z "$ARGOCD_SERVER" ]; then
            ARGOCD_SERVER="argocd-server.${{ env.ARGOCD_NAMESPACE }}.svc.cluster.local"
          fi
          
          echo "ARGOCD_SERVER=$ARGOCD_SERVER" >> $GITHUB_ENV
          echo "‚úÖ ArgoCD Server: $ARGOCD_SERVER"

      # 8Ô∏è‚É£ Install ArgoCD CLI
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
          rm argocd-linux-amd64
          argocd version --client

      # 9Ô∏è‚É£ Port Forward ArgoCD (for CLI access)
      - name: Setup ArgoCD port-forward
        run: |
          kubectl port-forward svc/argocd-server -n ${{ env.ARGOCD_NAMESPACE }} 8080:443 &
          sleep 5
          echo "ARGOCD_SERVER=localhost:8080" >> $GITHUB_ENV

      # üîü Login to ArgoCD
      - name: Login to ArgoCD
        run: |
          argocd login ${{ env.ARGOCD_SERVER }} \
            --username admin \
            --password ${{ env.ARGOCD_PASSWORD }} \
            --insecure

      # 1Ô∏è‚É£1Ô∏è‚É£ Create/Update ArgoCD Application
      - name: Update ArgoCD Application manifest
        run: |
          # Update application.yaml with actual values
          sed -i "s|PLACEHOLDER_ECR_REPO|${{ env.ECR_REPOSITORY }}|g" argocd/application.yaml
          sed -i "s|PLACEHOLDER_IMAGE_TAG|${{ env.IMAGE_TAG }}|g" argocd/application.yaml
          sed -i "s|YOUR_USERNAME|${{ github.repository_owner }}|g" argocd/application.yaml
          sed -i "s|YOUR_REPO|${{ github.event.repository.name }}|g" argocd/application.yaml
          
          echo "üìù Updated ArgoCD Application:"
          cat argocd/application.yaml

      # 1Ô∏è‚É£2Ô∏è‚É£ Apply ArgoCD Application
      - name: Deploy/Update ArgoCD Application
        run: |
          kubectl apply -f argocd/application.yaml
          
          echo "‚úÖ ArgoCD Application created/updated"

      # 1Ô∏è‚É£3Ô∏è‚É£ Sync Application (Force Deployment)
      - name: Sync ArgoCD Application
        run: |
          argocd app sync manar-app \
            --force \
            --timeout 300
          
          echo "üîÑ Application sync initiated"

      # 1Ô∏è‚É£4Ô∏è‚É£ Wait for Sync Completion
      - name: Wait for deployment
        run: |
          argocd app wait manar-app \
            --timeout 300 \
            --health
          
          echo "‚úÖ Application is healthy"

      # 1Ô∏è‚É£5Ô∏è‚É£ Get Application Status
      - name: Get ArgoCD Application Status
        run: |
          echo "üìä Application Status:"
          argocd app get manar-app
          
          echo ""
          echo "üîç Application Details:"
          kubectl get all -n default -l app.kubernetes.io/instance=manar-app

      # 1Ô∏è‚É£6Ô∏è‚É£ Verify Deployment
      - name: Verify deployment
        run: |
          echo "üîé Verifying deployment..."
          
          # Check pods
          kubectl get pods -n default -l app=manar-app
          
          # Check deployment
          kubectl rollout status deployment/manar-app -n default --timeout=300s
          
          # Get pod details
          echo ""
          echo "üì¶ Pod Details:"
          kubectl describe pods -n default -l app=manar-app | grep -A 5 "Image:"
          
          echo ""
          echo "‚úÖ Deployment verified successfully!"

      # 1Ô∏è‚É£7Ô∏è‚É£ Update Image Tag in Git (Optional - for GitOps)
      - name: Update Helm values in Git
        if: github.event_name == 'workflow_run'
        run: |
          # Update values.yaml with new image tag
          sed -i "s|tag:.*|tag: \"${{ env.IMAGE_TAG }}\"|g" helmchart/values.yaml
          
          # Commit and push if changes exist
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add helmchart/values.yaml
            git commit -m "üöÄ Update image tag to ${{ env.IMAGE_TAG }}"
            git push
            echo "‚úÖ Updated values.yaml with new image tag"
          fi

      # 1Ô∏è‚É£8Ô∏è‚É£ Deployment Summary
      - name: üöÄ Deployment Summary
        run: |
          echo "=============================================="
          echo "‚úÖ CD PIPELINE COMPLETED SUCCESSFULLY!"
          echo "=============================================="
          echo "üì¶ Application: manar-app"
          echo "üè∑Ô∏è  Image Tag: ${{ env.IMAGE_TAG }}"
          echo "üñºÔ∏è  ECR Repository: ${{ env.ECR_REPOSITORY }}"
          echo "üéØ Cluster: ${{ env.CLUSTER_NAME }}"
          echo "üåç Region: ${{ env.AWS_REGION }}"
          echo ""
          echo "üîó ArgoCD UI:"
          echo "   https://${{ env.ARGOCD_SERVER }}/applications/manar-app"
          echo ""
          echo "üìä Check status:"
          echo "   kubectl get all -n default -l app=manar-app"
          echo "=============================================="

      # 1Ô∏è‚É£9Ô∏è‚É£ Send Notification (Optional)
      - name: Send Slack notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            CD Pipeline ${{ job.status }}
            Application: manar-app
            Image: ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
            Environment: ${{ github.event.inputs.env }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
