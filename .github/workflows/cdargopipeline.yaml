name: CD Pipeline with ArgoCD

on:
  workflow_run:
    workflows: ["CI Docker + ECR + Helm Deployment"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: 'Deployment Mode'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - manual
      image_tag:
        description: 'Image Tag (if manual)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Download artifact from CI (Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)
      - name: Download CI outputs
        if: github.event_name == 'workflow_run'
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: ci-docker-ecr.yaml
          name: terraform-outputs
          path: .
          run_id: ${{ github.event.workflow_run.id }}

      # 2ï¸âƒ£b Download artifact manually (Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ)
      - name: Download latest CI outputs (manual mode)
        if: github.event_name == 'workflow_dispatch'
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: ci-docker-ecr.yaml
          name: terraform-outputs
          path: .
          workflow_conclusion: success
          search_artifacts: true

      # 3ï¸âƒ£ Parse outputs (FIXED - Security Hardened)
      - name: Parse CI outputs
        id: parse_outputs
        env:
          # âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… env variables Ù„Ù„Ø£Ù…Ø§Ù†
          MANUAL_IMAGE_TAG: ${{ github.event.inputs.image_tag }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ ! -f "tf-outputs.json" ]; then
            echo "âŒ tf-outputs.json not found!"
            exit 1
          fi
          
          CLUSTER_NAME=$(jq -r '.eks_cluster_name.value' tf-outputs.json)
          AWS_REGION=$(jq -r '.aws_region.value // "us-east-1"' tf-outputs.json)
          ECR_REPOSITORY=$(jq -r '.manar_app_ecr_url.value' tf-outputs.json)
          
          # âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… env variable Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ${{ }}
          if [ "$EVENT_NAME" == "workflow_dispatch" ] && [ -n "$MANUAL_IMAGE_TAG" ]; then
            IMAGE_TAG="$MANUAL_IMAGE_TAG"
          else
            IMAGE_TAG=$(jq -r '.image_tag.value' tf-outputs.json)
          fi
          
          echo "CLUSTER_NAME=$CLUSTER_NAME" >> $GITHUB_ENV
          echo "AWS_REGION=$AWS_REGION" >> $GITHUB_ENV
          echo "ECR_REPOSITORY=$ECR_REPOSITORY" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          
          echo "âœ… Deployment config:"
          echo "  Cluster: $CLUSTER_NAME"
          echo "  Region: $AWS_REGION"
          echo "  Image: $ECR_REPOSITORY:$IMAGE_TAG"

      # 4ï¸âƒ£ Configure AWS Credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 5ï¸âƒ£ Login to AWS ECR
      - name: Login to AWS ECR
        uses: aws-actions/amazon-ecr-login@v2

      # 6ï¸âƒ£ Scan image with Trivy (FIXED - Security Hardened)
      - name: Trivy vulnerability scan
        env:
          # âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… env variables
          IMAGE_REF: ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --severity CRITICAL,HIGH \
            --exit-code 1 \
            --no-progress \
            "$IMAGE_REF"

      # 7ï¸âƒ£ Manual Approval (FIXED - Security Hardened)
      - name: Manual Approval Gate
        if: github.event.inputs.deploy_mode == 'manual'
        uses: trstringer/manual-approval@v1
        env:
          # âœ… ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
          IMAGE_TAG_SAFE: ${{ env.IMAGE_TAG }}
          CLUSTER_SAFE: ${{ env.CLUSTER_NAME }}
          ECR_SAFE: ${{ env.ECR_REPOSITORY }}
        with:
          secret: ${{ github.TOKEN }}
          approvers: manaradel3812-creator
          minimum-approvals: 1
          issue-title: "Deploy Request - Image Tag ${{ env.IMAGE_TAG }}"
          issue-body: |
            **Deployment Request**
            
            Please review the following deployment:
            
            - **Image**: See issue metadata
            - **Cluster**: See issue metadata
            - **Region**: ${{ env.AWS_REGION }}
            
            Approve to proceed with deployment.

      # 8ï¸âƒ£ Checkout GitOps repository (FIXED)
      - name: Checkout GitOps repository
        env:
          GITOPS_TOKEN: ${{ secrets.GITOPS_TOKEN }}
        run: |
          git clone "https://${GITOPS_TOKEN}@github.com/manaradel3812-creator/nti-cloud-final-project.git" gitops-repo

      # 9ï¸âƒ£ Update Helm values.yaml (FIXED - Security Hardened)
      - name: Update Helm values.yaml
        env:
          # âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… env variable
          NEW_IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          cd gitops-repo
          
          # âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… double quotes Ù…Ø¹ env variable
          sed -i "s|tag:.*|tag: \"${NEW_IMAGE_TAG}\"|g" charts/hello-app/values.yaml
          
          echo "ğŸ“ Updated values.yaml:"
          grep -A2 "image:" charts/hello-app/values.yaml
          
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add charts/hello-app/values.yaml
          git commit -m "Update image tag to ${NEW_IMAGE_TAG} [skip ci]" || echo "No changes to commit"
          git push origin main

      # ğŸ”Ÿ Setup kubectl
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      # 1ï¸âƒ£1ï¸âƒ£ Setup Helm
      - name: Setup Helm
        uses: azure/setup-helm@v4

      # 1ï¸âƒ£2ï¸âƒ£ Update kubeconfig (FIXED)
      - name: Update kubeconfig
        env:
          # âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… env variables
          REGION: ${{ env.AWS_REGION }}
          CLUSTER: ${{ env.CLUSTER_NAME }}
        run: |
          aws eks update-kubeconfig \
            --region "$REGION" \
            --name "$CLUSTER"

      # 1ï¸âƒ£3ï¸âƒ£ Verify ArgoCD is installed
      - name: Check ArgoCD installation
        run: |
          if ! kubectl get namespace argocd &>/dev/null; then
            echo "âš ï¸ ArgoCD namespace not found! Installing..."
            kubectl create namespace argocd
            kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
            echo "âœ… ArgoCD installed. Waiting for pods..."
            kubectl wait --for=condition=Ready pods --all -n argocd --timeout=300s
          else
            echo "âœ… ArgoCD already installed"
          fi

      # 1ï¸âƒ£4ï¸âƒ£ Apply ArgoCD Application
      - name: Apply ArgoCD Application
        run: |
          kubectl apply -f gitops-repo/k8s-configs/argocd-app.yaml
          
          echo "âœ… ArgoCD Application deployed!"
          echo "ğŸ”„ ArgoCD will sync the changes automatically..."

      # 1ï¸âƒ£5ï¸âƒ£ Wait for ArgoCD sync
      - name: Wait for ArgoCD sync
        run: |
          echo "â³ Waiting for ArgoCD to detect changes..."
          sleep 30
          
          kubectl get application -n argocd 2>/dev/null || echo "ArgoCD app not ready yet"

      # 1ï¸âƒ£6ï¸âƒ£ Verify Deployment (FIXED)
      - name: Verify deployment
        env:
          DEPLOYED_IMAGE: ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
        run: |
          echo "ğŸ“Š Deployment Status:"
          kubectl get pods -n default
          kubectl get svc -n default
          kubectl get ingress -n default
          
          echo ""
          echo "ğŸ¯ Image deployed: $DEPLOYED_IMAGE"
