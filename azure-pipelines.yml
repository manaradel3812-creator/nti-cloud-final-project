trigger: none
pr: none

parameters:
  - name: env
    displayName: Environment
    type: string
    default: nonprod
    values: [nonprod, prod]

  - name: destroy
    displayName: Destroy
    type: boolean
    default: false

variables:
  TF_DIR: terraform
  TF_VAR_FILE: '${{ parameters.env }}.tfvars'
  AWS_REGION: us-east-1
  CLUSTER_NAME: 'nonprod-eks-cluster'
  HELM_NAMESPACE: 'kube-system'
  SERVICE_ACCOUNT: 'aws-load-balancer-controller'
  HELM_RELEASE: 'aws-load-balancer-controller'
  APP_DIR: k8s/hello-manar
  AWS_SERVICE_CONNECTION: manar # اسم الـ Service Connection الخاص بكِ

stages:

# =========================
# 1️⃣ Terraform Stage
# =========================
- stage: Infra
  displayName: Terraform Infra
  jobs:
    - job: Terraform
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self

        - task: TerraformInstaller@1
          displayName: Install Terraform
          inputs:
            terraformVersion: latest

        # استخدام AWSShellScript لضمان وصول Terraform للـ S3 Backend والـ AWS
        - task: AWSShellScript@1
          displayName: Terraform Init & Plan/Apply
          inputs:
            awsCredentials: $(AWS_SERVICE_CONNECTION)
            regionName: $(AWS_REGION)
            scriptType: inline
            inlineScript: |
              cd "$(TF_DIR)"
              terraform init -input=false
              
              if [ "${{ parameters.destroy }}" == "true" ]; then
                terraform destroy -auto-approve -var-file="$(TF_VAR_FILE)"
              else
                terraform apply -auto-approve -var-file="$(TF_VAR_FILE)"
              fi

# =========================
# 2️⃣ ALB Helm Stage
# =========================
- stage: ALB_Controller
  dependsOn: Infra
  condition: succeeded()
  displayName: Install ALB Controller
  jobs:
    - job: Helm_ALB
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self

        - task: KubectlInstaller@0
          inputs: {versionSpec: 'latest'}
        - task: HelmInstaller@1
          inputs: {helmVersionToInstall: 'latest'}

        # الخطوة الحاسمة: استخدام AWSShellScript لتنفيذ أوامر kubectl و helm
        - task: AWSShellScript@1
          displayName: "Configure K8s & Deploy ALB Controller"
          inputs:
            awsCredentials: $(AWS_SERVICE_CONNECTION)
            regionName: $(AWS_REGION)
            scriptType: inline
            inlineScript: |
              set -euo pipefail
              
              # تحديث التوثيق للـ Cluster
              aws eks update-kubeconfig --name $(CLUSTER_NAME) --region $(AWS_REGION)
              
              # إنشاء الـ Namespace والـ Service Account بصلاحيات IRSA
              kubectl create namespace $(HELM_NAMESPACE) --dry-run=client -o yaml | kubectl apply -f -
              
              kubectl create serviceaccount $(SERVICE_ACCOUNT) -n $(HELM_NAMESPACE) --dry-run=client -o yaml | kubectl apply -f -
              
              # جلب الـ ARN الخاص بالـ Role الذي تم إنشاؤه بواسطة Terraform
              ROLE_ARN=$(aws iam get-role --role-name $(CLUSTER_NAME)-alb-controller-role --query Role.Arn --output text)
              
              kubectl annotate serviceaccount $(SERVICE_ACCOUNT) \
                eks.amazonaws.com/role-arn=$ROLE_ARN \
                -n $(HELM_NAMESPACE) --overwrite
              
              # تثبيت ALB Controller باستخدام Helm
              helm repo add eks https://aws.github.io/eks-charts
              helm repo update
              helm upgrade --install $(HELM_RELEASE) eks/aws-load-balancer-controller \
                -n $(HELM_NAMESPACE) \
                --set clusterName=$(CLUSTER_NAME) \
                --set serviceAccount.create=false \
                --set serviceAccount.name=$(SERVICE_ACCOUNT)

# =========================
# 3️⃣ Deploy App Stage
# =========================
- stage: Deploy_App
  dependsOn: ALB_Controller
  condition: succeeded()
  displayName: Deploy Application
  jobs:
    - job: Deploy_App
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self

        - task: KubectlInstaller@0
          inputs: {versionSpec: 'latest'}

        # تحويل هذه الخطوة أيضاً لـ AWSShellScript لضمان صلاحيات kubectl apply
        - task: AWSShellScript@1
          displayName: "Update Kubeconfig & Deploy App"
          inputs:
            awsCredentials: $(AWS_SERVICE_CONNECTION)
            regionName: $(AWS_REGION)
            scriptType: inline
            inlineScript: |
              set -euo pipefail
              aws eks update-kubeconfig --name $(CLUSTER_NAME) --region $(AWS_REGION)
              
              # التأكد من المسار قبل التنفيذ
              if [ -d "$(APP_DIR)" ]; then
                kubectl apply -f $(APP_DIR)/
              else
                echo "❌ Directory $(APP_DIR) not found!"
                exit 1
              fi