trigger: none
pr: none

parameters:
  - name: env
    displayName: Environment
    type: string
    default: nonprod
    values: [nonprod, prod]

  - name: destroy
    displayName: Destroy Infra
    type: boolean
    default: false

variables:
  AWS_REGION: us-east-1
  AWS_SERVICE_CONNECTION: manar
  TF_DIR: terraform
  TF_VAR_FILE: '${{ parameters.env }}.tfvars'
  CLUSTER_NAME: '${{ parameters.env }}-eks-cluster'

#################################
# Stage 1: Terraform Infra
#################################
stages:
- stage: Infra
  displayName: Terraform Infra
  jobs:
  - job: Terraform
    pool:
      name: aws-self-hosted
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      inputs:
        terraformVersion: latest

    - task: AWSShellScript@1
      displayName: Terraform Init
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -e
          cd $(TF_DIR)
          terraform init

    - task: AWSShellScript@1
      displayName: Terraform Plan
      condition: eq('${{ parameters.destroy }}', false)
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -e
          cd $(TF_DIR)
          terraform plan -out=tfplan -var-file=$(TF_VAR_FILE)

    - task: AWSShellScript@1
      displayName: Terraform Destroy Plan
      condition: eq('${{ parameters.destroy }}', true)
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -e
          cd $(TF_DIR)
          terraform plan -destroy -out=tfplan -var-file=$(TF_VAR_FILE)

    - task: AWSShellScript@1
      displayName: Terraform Apply
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -e
          cd $(TF_DIR)
          terraform apply -auto-approve tfplan

#################################
# Stage 2: Platform / Helm
#################################
- stage: Platform
  displayName: Platform & Helm
  dependsOn: Infra
  condition: succeeded('Infra')
  jobs:
  - job: Helm
    pool:
      name: aws-self-hosted
    steps:
    - checkout: self

    # 1️⃣ Setup kubeconfig + export AWS creds
    - task: AWSShellScript@1
      displayName: Setup EKS Access
      name: setup
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail

          aws eks update-kubeconfig \
            --name $(CLUSTER_NAME) \
            --region $(AWS_REGION)

          VPC_ID=$(aws eks describe-cluster \
            --name $(CLUSTER_NAME) \
            --query "cluster.resourcesVpcConfig.vpcId" \
            --output text)

          echo "##vso[task.setvariable variable=VPC_ID]$VPC_ID"
          echo "##vso[task.setvariable variable=AWS_ACCESS_KEY_ID;issecret=true]$AWS_ACCESS_KEY_ID"
          echo "##vso[task.setvariable variable=AWS_SECRET_ACCESS_KEY;issecret=true]$AWS_SECRET_ACCESS_KEY"
          echo "##vso[task.setvariable variable=AWS_SESSION_TOKEN;issecret=true]${AWS_SESSION_TOKEN:-}"

    # 2️⃣ Helm repos
    - task: Bash@3
      displayName: Helm Repos
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_SESSION_TOKEN: $(AWS_SESSION_TOKEN)
        AWS_DEFAULT_REGION: $(AWS_REGION)
      inputs:
        targetType: inline
        script: |
          set -e
          helm repo add eks https://aws.github.io/eks-charts
          helm repo add jetstack https://charts.jetstack.io
          helm repo add argo https://argoproj.github.io/argo-helm
          helm repo add hashicorp https://helm.releases.hashicorp.com
          helm repo add external-secrets https://charts.external-secrets.io
          helm repo update

    # 3️⃣ AWS Load Balancer Controller
    - task: HelmDeploy@0
      displayName: Install AWS Load Balancer Controller
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_SESSION_TOKEN: $(AWS_SESSION_TOKEN)
        AWS_DEFAULT_REGION: $(AWS_REGION)
      inputs:
        connectionType: None
        namespace: kube-system
        command: upgrade
        chartType: Name
        chartName: eks/aws-load-balancer-controller
        releaseName: aws-load-balancer-controller
        install: true
        arguments: >
          --set clusterName=$(CLUSTER_NAME)
          --set region=$(AWS_REGION)
          --set vpcId=$(VPC_ID)

    # 4️⃣ cert-manager
    - task: HelmDeploy@0
      displayName: Install cert-manager
      inputs:
        connectionType: None
        namespace: cert-manager
        command: upgrade
        chartType: Name
        chartName: jetstack/cert-manager
        releaseName: cert-manager
        install: true
        arguments: --create-namespace --set installCRDs=true

    # 5️⃣ Argo CD
    - task: HelmDeploy@0
      displayName: Install Argo CD
      inputs:
        connectionType: None
        namespace: argocd
        command: upgrade
        chartType: Name
        chartName: argo/argo-cd
        releaseName: argocd
        install: true
        arguments: --create-namespace
