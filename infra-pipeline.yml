trigger: none
pr: none

parameters:
  - name: env
    displayName: Environment
    type: string
    default: nonprod
    values: [nonprod, prod]
  - name: destroy
    displayName: Destroy Infrastructure
    type: boolean
    default: false

variables:
  TF_DIR: terraform
  TF_VAR_FILE: '${{ parameters.env }}.tfvars'
  AWS_SERVICE_CONNECTION: manar
  AWS_REGION: us-east-1
  CLUSTER_NAME: '${{ parameters.env }}-eks-cluster'

stages:
  - stage: Infra
    displayName: "Infra (Terraform + OIDC)"
    jobs:
      - job: Terraform
        displayName: "Terraform & Post-Config"
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self

          - task: TerraformInstaller@1
            inputs: { terraformVersion: latest }

          # 1ï¸âƒ£ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù…Ø³Ø¨Ø¨ Ù„Ù„Ø®Ø·Ø£
          - bash: |
              cd "$(TF_DIR)"
              echo "ğŸ§¹ Cleaning up unsupported arguments..."
              sed -i '/enable_irsa/d' *.tf
            displayName: "Pre-processing: Clean Terraform Code"

          # 2ï¸âƒ£ ØªØ´ØºÙŠÙ„ Terraform (Init -> Plan -> Apply)
          - task: AWSShellScript@1
            displayName: "Terraform Execution"
            inputs:
              awsCredentials: $(AWS_SERVICE_CONNECTION)
              regionName: $(AWS_REGION)
              scriptType: inline
              inlineScript: |
                set -euo pipefail
                cd "$(TF_DIR)"
                
                terraform init -input=false
                
                ACTION_FLAG=""
                if [ "${{ parameters.destroy }}" = "true" ]; then ACTION_FLAG="-destroy"; fi
                
                terraform plan $ACTION_FLAG -out=tfplan -input=false -var-file="$(TF_VAR_FILE)"
                terraform apply -auto-approve -input=false tfplan

          # 3ï¸âƒ£ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ OIDC Provider (Ø§Ù„Ø¨Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„Ù€ enable_irsa)
          - task: AWSShellScript@1
            displayName: "Enable OIDC Provider"
            condition: and(succeeded(), eq('${{ parameters.destroy }}', false))
            inputs:
              awsCredentials: $(AWS_SERVICE_CONNECTION)
              regionName: $(AWS_REGION)
              scriptType: inline
              inlineScript: |
                set -euo pipefail
                echo "ğŸŒ Creating OIDC Identity Provider for cluster: $(CLUSTER_NAME)"
                
                # ØªØ­Ù…ÙŠÙ„ Ø£Ø¯Ø§Ø© eksctl Ù„Ø£Ù†Ù‡Ø§ Ø£Ø³Ù‡Ù„ Ø·Ø±ÙŠÙ‚Ø© Ù„Ø±Ø¨Ø· Ø§Ù„Ù€ OIDC
                curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
                sudo mv /tmp/eksctl /usr/local/bin
                
                # ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ OIDC
                eksctl utils associate-iam-oidc-provider --region $(AWS_REGION) --cluster $(CLUSTER_NAME) --approve
                
                echo "âœ… OIDC Provider is ready for IRSA."