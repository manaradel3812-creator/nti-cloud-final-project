- stage: Infra
  displayName: Terraform Infra
  jobs:
    - job: Terraform
      pool:
        name: aws-self-hosted
      steps:
        - checkout: self

        # -------------------------
        # Install Terraform
        # -------------------------
        - task: TerraformInstaller@1
          displayName: Install Terraform
          inputs:
            terraformVersion: latest

        # -------------------------
        # Check AWS Credentials
        # -------------------------
        - task: AWSShellScript@1
          displayName: "Check AWS Credentials"
          inputs:
            awsCredentials: $(AWS_SERVICE_CONNECTION)
            regionName: $(AWS_REGION)
            scriptType: inline
            inlineScript: |
              set -euo pipefail
              echo "✅ AWS Caller Identity:"
              aws sts get-caller-identity

        # -------------------------
        # Terraform Init
        # -------------------------
        - task: AWSShellScript@1
          displayName: Terraform Init
          inputs:
            awsCredentials: $(AWS_SERVICE_CONNECTION)
            regionName: $(AWS_REGION)
            scriptType: inline
            inlineScript: |
              set -euo pipefail
              cd $(TF_DIR)
              terraform init -input=false

        # -------------------------
        # Terraform Plan (Create/Update)
        # -------------------------
        - task: AWSShellScript@1
          displayName: Terraform Plan
          condition: eq('${{ parameters.destroy }}', false)
          inputs:
            awsCredentials: $(AWS_SERVICE_CONNECTION)
            regionName: $(AWS_REGION)
            scriptType: inline
            inlineScript: |
              set -euo pipefail
              cd $(TF_DIR)
              if [[ ! -f "$(TF_VAR_FILE)" ]]; then
                echo "❌ Variables file '$(TF_VAR_FILE)' not found in $(TF_DIR)"
                exit 1
              fi
              terraform plan -out=tfplan -input=false -var-file="$(TF_VAR_FILE)"

        # -------------------------
        # Terraform Plan (Destroy)
        # -------------------------
        - task: AWSShellScript@1
          displayName: Terraform Destroy Plan
          condition: eq('${{ parameters.destroy }}', true)
          inputs:
            awsCredentials: $(AWS_SERVICE_CONNECTION)
            regionName: $(AWS_REGION)
            scriptType: inline
            inlineScript: |
              set -euo pipefail
              cd $(TF_DIR)
              if [[ ! -f "$(TF_VAR_FILE)" ]]; then
                echo "❌ Variables file '$(TF_VAR_FILE)' not found in $(TF_DIR)"
                exit 1
              fi
              terraform plan -destroy -out=tfplan -input=false -var-file="$(TF_VAR_FILE)"

        # -------------------------
        # Terraform Apply
        # -------------------------
        - task: AWSShellScript@1
          displayName: Terraform Apply
          inputs:
            awsCredentials: $(AWS_SERVICE_CONNECTION)
            regionName: $(AWS_REGION)
            scriptType: inline
            inlineScript: |
              set -euo pipefail
              cd $(TF_DIR)
              if [[ ! -f "tfplan" ]]; then
                echo "❌ Terraform plan 'tfplan' not found"
                exit 1
              fi
              terraform apply -auto-approve -input=false tfplan
